"use strict";angular.module("theVarApp",["ngMessages","ngRoute","ui.bootstrap","base64","ui.chart","angularMoment"]).config(["$routeProvider","$logProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/assetAdd",{templateUrl:"views/assetAdd.html",controller:"AssetAddCtrl",controllerAs:"assetAdd"}).when("/portfolioList",{templateUrl:"views/portfoliolist.html",controller:"PortfoliolistCtrl",controllerAs:"portfolioList"}).when("/portfolioAdd",{templateUrl:"views/portfolioadd.html",controller:"PortfolioaddCtrl",controllerAs:"portfolioAdd"}).when("/portfolioShow/:pid",{templateUrl:"views/portfolioshow.html",controller:"PortfolioshowCtrl",controllerAs:"portfolioShow"}).when("/assetShow/:src/:symbol",{templateUrl:"views/assetshow.html",controller:"AssetshowCtrl",controllerAs:"assetShow"}).when("/assetList",{templateUrl:"views/assetlist.html",controller:"AssetlistCtrl",controllerAs:"assetList"}).when("/Settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl",controllerAs:"Settings"}).otherwise({redirectTo:"/"}),b.debugEnabled(!0)}]),angular.module("theVarApp").controller("MainCtrl",["$scope","Portfolios",function(a,b){a.np=function(){return b.np()}}]),angular.module("theVarApp").controller("AssetAddCtrl",["$scope","varCalc","markitOnDemand","Portfolios","$routeParams","$location",function(a,b,c,d,e,f){a.add1=function(){var b="mod",c=a.asyncSelected.Symbol;a.asyncSelected=null;var d="/assetShow/"+b+"/"+c;e.pid?f.path(d).search("pid="+e.pid):f.path(d)},a.getSymbol=function(b){return a.pa=0,a.asyncSelected=null,c.lookup(b)},a.modelOptions={debounce:{default:500,blur:250},getterSetter:!0},a.getQuote=function(a){return c.quote(a)},a.gcs=0,a.pa=0,a.getChart=function(){if(a.asyncSelected){var b=a.asyncSelected.Symbol;return a.gcs=1,c.interactiveChart(b).then(function(b){return a.gcs=0,0===b.data.Elements.length?void(a.pa=1):void(a.pa=2)})}}}]),angular.module("theVarApp").directive("jqSparkline",["$timeout",function(a){return{restrict:"A",require:"ngModel",link:function(b,c,d,e){var f={};f.type=d.type||"line";var g=function(){var a;d.opts&&angular.extend(f,angular.fromJson(d.opts)),a=angular.isString(e.$viewValue)?e.$viewValue.replace(/(^,)|(,$)/g,""):e.$viewValue;var b;b=angular.isArray(a)?a:a.split(","),$(c).sparkline(b,f)};b.$watch(d.ngModel,function(){a(function(){g()},100)}),b.$watch(d.opts,function(){a(function(){g()},100)})}}}]),angular.module("theVarApp").controller("PortfoliolistCtrl",["$scope","Portfolios","ActivateNavBar","Assets","varCalc","ffa",function(a,b,c,d,e,f){c.portfolios(),angular.element(document).ready(function(){f.checkAvailable()}),a.ffaPortfolios=function(){f.portfolios()},a.ffaReadyForPrices=function(){return f.readyForPrices()},a.ffaPrices=function(){f.portfolioPrices()},a.ffaPStatus=function(){return f.getStatus()},a.ffaGA=function(){return f.getAvailable()},a.ffaCA=function(){return f.checkAvailable()},a.ffaAbort=function(){f.setAbort()},a.np=function(){return b.np()},a.list=function(){return b.list()},a.nass=function(a){var c=b.list();return c.hasOwnProperty(a)?(c=c[a],c.hasOwnProperty("assets")?(c=c.assets,Object.keys(c).length):0):0},a.portfolioVaR=function(a,b,c){var f=b.assets;if(!f)return 0;var g=d.list(),h=f.map(function(a){return g.hasOwnProperty(a.src)&&g[a.src].hasOwnProperty(a.symbol)?g[a.src][a.symbol]:null}).filter(function(a){return!!a}),i=e.portfolioVaR(a,h,c);return i}}]),angular.module("theVarApp").controller("PortfolioaddCtrl",["$scope","Portfolios","$location","ActivateNavBar",function(a,b,c,d){d.portfolios(),a.add=function(){if(a.portfolios||(a.portfolios={}),a.exists())return void console.error("Portfolio name already exists");a.newP.src="Manual";var d=b.add(a.newP.src,a.newP.name,[]);return d&&c.url("/portfolioShow/"+d),d},a.exists=function(){if(!a.newP)return!1;var c=b.list();return Object.keys(c).filter(function(b){return c[b].name===a.newP.name}).length>0}}]),angular.module("theVarApp").service("Portfolios",["Assets",function(a){var b={};return localStorage.getItem("ppp")&&(b=angular.fromJson(localStorage.getItem("ppp"))),{set:function(a){b=a},list:function(){return b},np:function(){return Object.keys(b).length},add:function(a,c,d){var e={name:c,src:a,assets:d,cash:0,value:0};if(!c||!a)return console.error("Adding invalid portfolio "+angular.toJson(e)),!1;if(e.id=this.newId(),b.hasOwnProperty(e.id))return console.error("ID "+e.id+" already exists"),!1;var f=Object.keys(b).filter(function(a){return b[a].src===e.src&&b[a].name===e.name});return f.length>0?(console.error("Portfolios already contain ",e),b[f[0]].assets=angular.fromJson(angular.toJson(e.assets)),this.updateValue(b[f[0]].id),this.saveToLs(),b[f[0]].id):(b[e.id]=angular.fromJson(angular.toJson(e)),this.updateValue(e.id),this.saveToLs(),e.id)},del:function(a){delete b[a],this.saveToLs()},saveToLs:function(){localStorage.setItem("ppp",angular.toJson(b))},clear:function(){localStorage.removeItem("ppp"),b={}},addAsset:function(a,c){return b.hasOwnProperty(a)?(b[a].assets||(b[a].assets=[]),void(0===b[a].assets.filter(function(a){return a.src===c.src&&a.symbol===c.lookup.Symbol}).length&&(b[a].assets.push({src:c.src,symbol:c.lookup.Symbol,qty:0,pct:0}),this.updateAsset(a,c),this.updateValue(a),this.saveToLs()))):(console.error("Invalid portfolio ID "+a),!1)},rmAsset:function(a,c){if(!b.hasOwnProperty(a))return console.error("Invalid portfolio ID "+a),!1;var d=b[a].assets.filter(function(a){return a.src!==c.src||a.symbol!==c.lookup.Symbol});b[a].assets=d,this.updateValue(a),this.saveToLs()},holdingAsset:function(a,c,d){var e=this;return Object.keys(b).filter(function(f){if(!b[f].hasOwnProperty("assets"))return console.error("portfolio missing assets field"),!!d;var g=e.listAssets(f),h=g.filter(function(b){return b.src===a&&b.symbol===c}).length>0;return d?!h:h}).map(function(a){return b[a]})},newId:function(){var a=1;if(0!==this.np()){var b=this.list();a=Object.keys(b).map(function(a){return b[a].id}),a=a.reduce(function(a,b){return a<b?b:a}),a=1+a}return a},updateAsset:function(c,d){if(!b.hasOwnProperty(c))return console.error("Invalid portfolio ID "+c),!1;var e=this,f=a.list();b[c].assets=b[c].assets.map(function(a){return a.src===d.src&&a.symbol===d.lookup.Symbol&&(a.qty=d.qty?d.qty:0,a.historyMeta=f[d.src][d.lookup.Symbol].historyMeta),a}),this.updateValue(c),b[c].assets=b[c].assets.map(function(a){return a.src===d.src&&a.symbol===d.lookup.Symbol&&(a.pct=e.qty2pct(a,b[c])),a}),this.saveToLs()},updateName:function(a,c){return b.hasOwnProperty(a)?(b[a].name=c,void this.saveToLs()):(console.error("Invalid portfolio ID "+a),!1)},updateCash:function(a,c){if(!b.hasOwnProperty(a))return console.error("Invalid portfolio ID "+a),!1;b[a].cash=c,this.updateValue(a);var d=this;this.listAssets(a).filter(function(b){b.lookup={Symbol:b.symbol},d.updateAsset(a,b)}),this.saveToLs()},updateValue:function(a){if(!b.hasOwnProperty(a))return console.error("Invalid portfolio ID "+a),!1;var c=this,d=this.listAssets(a),e=d.map(function(a){return c.qty2usd(a)}).reduce(function(a,b){return a+b},0);b[a].value=b[a].cash+e},listAssets:function(c){if(!b.hasOwnProperty(c))return console.error("listAssets: Invalid portfolio ID "+c),[];var d=b[c].assets;if(!d)return[];var e=a.list(),f=d.map(function(a){if(e.hasOwnProperty(a.src)&&e[a.src].hasOwnProperty(a.symbol)){var b=e[a.src][a.symbol];return b.src=a.src,b.symbol=a.symbol,b.qty=a.qty,b.pct=a.pct,b}return null}).filter(function(a){return!!a});return f},qty2pct:function(a,b){return b?b.value?this.qty2usd(a)/b.value*100:(console.error("No portfolio value available in qty2pct. Aborting"),0):(console.error("portfolio argument undefined. Aborting"),0)},qty2usd:function(a){return a.historyMeta?a.qty*a.historyMeta.lastprice:0},unallocated:function(a){if(!a)return!1;if(!b.hasOwnProperty(a))return console.error("unallocated: Invalid portfolio ID "+a),!1;var c=this.listAssets(a);return c=c.map(function(a){return a.pct}),100-c.reduce(function(a,b){return a+b},0)}}}]),angular.module("theVarApp").controller("PortfolioshowCtrl",["$scope","Portfolios","$routeParams","varCalc","Assets","ActivateNavBar",function(a,b,c,d,e,f){f.portfolios();var g,h;a.portfolio=null,a.alist=null,a.showNoData=!0,a.set=function(c){return g=c,h=b.list(),h.hasOwnProperty(g)?(a.portfolio=h[g],void(a.alist=a.list())):(window.location.href="#/portfolioList",void console.error("portfolioshowctrl/set: Invalid portfolio id "+g))},a.list=function(){return b.listAssets(a.portfolio.id)},c.pid&&a.set(c.pid),a.calculateVaR=function(a,b,c){return d.calculateVaR(a,b,c)},a.edf=function(a,b){return d.edf(a,b)},a.portfolioVaR=function(b,c){return d.portfolioVaR(b,a.alist,c)},a.delAsset=function(c){window.confirm("Are you sure you want to delete the asset from the portfolio?")&&(b.rmAsset(g,c),a.portfolio=b.list()[g],a.alist=a.list())},a.delPortfolio=function(){window.confirm("Are you sure you want to delete the portfolio?")&&(b.del(g),window.location.href="#/portfolioList")},a.updateAsset=function(a){b.updateAsset(g,a)},a.qty2pct=function(a,c){return b.qty2pct(a,c)},a.updateName=function(){b.updateName(a.portfolio.id,a.portfolio.name)},a.updateCash=function(){b.updateCash(a.portfolio.id,a.portfolio.cash)},a.unallocated=function(){return b.unallocated(a.portfolio.id)}}]),angular.module("theVarApp").service("varCalc",function(){return{prices2pnls:function(a,b){if(a.length-1<b)return[];for(var c=[],d=b;d<a.length;d++)d%b===0&&c.push(a[d]/a[d-b]-1);return c},calculateVaR:function(a,b,c){if(a.historyDateless&&0!==a.historyDateless.length&&!(c<=0||a.historyDateless.length<c)){var d=this.prices2pnls(a.historyDateless,c);if(0!==d.length){d.sort(function(a,b){return a-b});var e=d.length,f=e*((100-b)/100)-1,g=Math.min(e-1,Math.max(0,Math.ceil(f))),h=Math.min(e-1,Math.max(0,Math.floor(f)));return h===g?d[g]:(g-f)*d[h]+(f-h)*d[g]}}},edf:function(a,b){var c=angular.fromJson(angular.toJson(a));c.sort(function(a,b){return a-b});var d=c.reduce(function(a,b){return Math.min(a,b)},99999999);d=Math.floor(d/b)*b;for(var e=c.map(function(a){return Math.floor((a-d)/b)}),f=[],g=[],h=0;h<e.length;h++){var i=1;c[h]<0&&(i=-1),g.indexOf(e[h])===-1?(f.push(i),g.push(e[h])):f[f.length-1]+=i}var j=f.map(function(a){return a/c.length*100});return j},portfolioVaR:function(a,b,c){if(b&&c&&!(c<=0)){var d=Object.keys(b);if(0===d.length)return 0;var e=d.map(function(a){return Math.abs(b[a].pct)}).reduce(function(a,b){return b?a+b:a},0),f=this,g=d.map(function(a){return b[a].pct?e&&b[a].historyDateless?(b[a].pnls=f.prices2pnls(b[a].historyDateless,c),b[a].pnls.map(function(c){var d=c*b[a].pct/e;return d})):(console.error("missing other than field pct: ",a),[]):[]}),h=g.reduce(function(a,b){if(!a)return b;if(!a.length)return b;if(!b)return a;if(!b.length)return a;if(a.length!==b.length)return console.error("Cannot add pnls of different lengths",a.length,b.length),a;for(var c=[],d=0;d<a.length;d++)c.push(a[d]+b[d]);return c},[]);if(!h)return 0;if(!h.length)return 0;var i=this.pnls2prices(h);return this.calculateVaR({historyDateless:i},a,1)}},pnls2prices:function(a){return a.map(function(a){return 1+a}).reduce(function(a,b){return a.push(a[a.length-1]*b),a},[100])}}}),angular.module("theVarApp").service("markitOnDemand",["$http","Settings","moment",function(a,b,c){return{lookup:function(b){var c="http://dev.markitondemand.com/MODApis/Api/v2/Lookup/jsonp";return a.jsonp(c,{params:{input:b,jsoncallback:"JSON_CALLBACK"}}).then(function(a){return a.data})},quote:function(b){var c="http://dev.markitondemand.com/MODApis/Api/v2/Quote/jsonp";return a.jsonp(c,{params:{symbol:b.symbol.Symbol,jsoncallback:"JSON_CALLBACK"}}).then(function(a){return a.data})},interactiveChart:function(d){var e="http://dev.markitondemand.com/MODApis/Api/v2/InteractiveChart/jsonp",f={DataPeriod:"Day",NumberOfDays:365,Normalized:!1,Elements:[{Symbol:d,Type:"price",Params:["c"]}]};return b.end.date===c().format("YYYY-MM-DD")&&1===b.length.n&&"year"===b.length.y||(delete f.NumberOfDays,f.StartDate=b.start()+"T23:00:00-00",f.EndDate=b.end.date+"T23:00:00-00"),a.jsonp(e,{params:{parameters:f,jsoncallback:"JSON_CALLBACK"}})}}}]),angular.module("theVarApp").controller("AssetshowCtrl",["$routeParams","markitOnDemand","varCalc","Assets","$scope","Portfolios","ActivateNavBar","ffa","$location","$log",function(a,b,c,d,e,f,g,h,i,j){g.assets(),e.pendingStock=!1;var k,l;e.goback=function(){a.pid&&i.url("/portfolioShow/"+a.pid)},e.set=function(a,b){if(a&&b){k=a,l=b;var c=d.list();return c.hasOwnProperty(l)&&c[l].hasOwnProperty(k)?(e.pendingStock=c[l][k],!1):!e.pendingStock&&e.add1()}},e.add1=function(){return b.lookup(k).then(function(a){var b=a.filter(function(a){return a.Symbol===k});return 0===b.length?void console.error("Couldnt identify symbol"):(b=b[0],e.pendingStock={src:l,lookup:b},e.getChart())})},e.set(a.symbol,a.src),e.getPid=function(){return a.pid},e.add2=function(a){f.addAsset(a,e.pendingStock),e.pendingStock=!1,e.asyncSelected=null,i.url("/portfolioShow/"+a)},e.noPortfolios=function(){return 0===f.np()},e.inPortfolios=function(a){return!e.pendingStock||e.noPortfolios()?[]:f.holdingAsset(l,k,a)},e.gcs=function(){return d.getGcs()},e.getChart=function(){if("FFA MF"!==l)return e.getChartCore(!1);var a=h.ffaConfig1();a?a.then(function(a){return j.debug("conf",a),e.getChartCore(a)}):console.error("Failed to get ffa config")},e.getChartCore=function(a){return d.getChartAndUpdate(e.pendingStock,a)},e.showChart=function(a){j.debug(a)},e.calculateVaR=function(a,b,d){return c.calculateVaR(a,b,d)},e.edf=function(a,b){return c.edf(a,b)},e.myChartOpts={},e.myChartOpts.usd={title:"Default Date Axis",axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickOptions:{formatString:"%Y-%m-%d"}},yaxis:{tickOptions:{formatString:"$%.2f"}}},highlighter:{show:!0,sizeAdjust:7.5},cursor:{show:!0,showTooltip:!1,zoom:!0,looseZoom:!0},series:[{lineWidth:1,shadow:!1,showMarker:!1}]},e.myChartOpts.perc=angular.fromJson(angular.toJson(e.myChartOpts.usd)),e.myChartOpts.perc.axes.xaxis.renderer=$.jqplot.DateAxisRenderer,e.myChartOpts.perc.axes.yaxis.tickOptions.formatString="%%%.2f",j.debug(e.myChartOpts.perc)}]),angular.module("theVarApp").service("Assets",["markitOnDemand","varCalc","$http","moment","Settings","$log",function(a,b,c,d,e,f){var g={};localStorage.getItem("aaa")&&(g=angular.fromJson(localStorage.getItem("aaa")));var h=0;return{setAAA:function(a){g=a},add:function(a){g.hasOwnProperty(a.src)||(g[a.src]={}),g[a.src].hasOwnProperty(a.lookup.Symbol)?console.error("Assets already contain "+a.src+" "+a.lookup.Symbol):(g[a.src][a.lookup.Symbol]=a,this.saveToLs())},list:function(){return g},listFlat:function(){var a=this.list(),b=[];return Object.keys(a).map(function(c){Object.keys(a[c]).map(function(d){b.push(a[c][d])})}),b},saveToLs:function(){localStorage.setItem("aaa",angular.toJson(g))},na:function(){return this.listFlat().length},del:function(a,b){this.exists(a,b)&&(delete g[a][b],0===Object.keys(g[a]).length&&delete g[a],this.saveToLs())},exists:function(a,b){return!!g.hasOwnProperty(a)&&!!g[a].hasOwnProperty(b)},getChart:function(b,d,g){f.debug("Getting prices",b,d),h=1;var i=this;if("mod"===b)return a.interactiveChart(d).then(function(a){return h=0,i.treatChart(a.data)},function(){h=2});if("FFA MF"===b){var j=d;"string"!=typeof d&&"FFA MF"===b&&"[object Array]"===Object.prototype.toString.call(d)&&(j=d.join('","'));var k=g.endPoints.prices+'?format=json&tkr=["'+j+'"]&start='+e.dashless().start+"&end="+e.dashless().end;return f.debug("assets get chart",k),c.get(k).then(function(a){f.debug("res ass",k,a),h=0;var b={};for(var c in a.data)f.debug("_____",c,a.data[c]),b[c]=i.treatChart(a.data[c]);return b},function(){h=2})}console.error("Unsupported source")},treatChart:function(a){if(f.debug("treat chart",a),f.debug(a),0!==a.Elements.length){var c=a.Dates;c=c.map(function(a){return a.replace("T00:00:00","")});for(var d=a.Elements[0].DataSeries.close.values,e=[],g=0;g<c.length;g++)e.push({date:c[g],close:d[g]});var h={};h.history=e,h.historyDateless=d,h.historyDownsampled=this.downsample(d,100);var i=this.findPrevEom(c,"month"),j=this.findPrevEom(c,"year");for(h.historyMeta={mindate:c[0],maxdate:c[c.length-1],lastprice:d[c.length-1],firstprice:d[0],prevEomDate:i!==-1?c[i]:"N/A",prevEomClose:i!==-1?d[i]:"N/A",prevEoyDate:j!==-1?c[j]:"N/A",prevEoyClose:j!==-1?d[j]:"N/A",tm1date:c.length>1?c[c.length-2]:"N/A",tm1price:c.length>1?d[c.length-2]:"N/A"},h.historyJqplot=[],g=0;g<c.length;g++)h.historyJqplot.push([c[g],d[g]]);var k=[];for(k.push(0),g=1;g<d.length;g++)k.push(d[g]/d[g-1]-1);for(h.pnls=k,h.pnlsDownsampled=this.downsample(k.map(function(a){return 100*a}),100),h.historyMeta.pnl={last:100*h.pnls[h.pnls.length-1],eom:100*(d[d.length-1]/d[i]-1),eoy:100*(d[d.length-1]/d[j]-1),first:100*(d[d.length-1]/d[0]-1)},h.pnlsJqplot=[],g=1;g<d.length;g++)h.pnlsJqplot.push([c[g],100*(d[g]/d[g-1]-1)]);var l=angular.fromJson(angular.toJson(k));return l.sort(function(a,b){return a-b}),h.pnlsSort=l,h.pnlsEdf=b.edf(k,.01),h}},downsample:function(a,b){for(var c=angular.fromJson(angular.toJson(a)),d=[],e=Math.floor(c.length/b),f=0;f<c.length;f++)f%e===0&&d.push(c[f]);return d},findPrevEom:function(a,b){if("month"!==b&&"year"!==b)return console.error("Unsupported target"),-1;var c=a[a.length-1],e=d(c,"YYYY-MM-DD").startOf(b).subtract(1,"days").format("YYYY-MM-DD"),f=a.indexOf(e);if(f!==-1)return f;var g=a.filter(function(a){return a<e});return g.length>0&&(g=g[g.length-1],f=a.indexOf(g),f!==-1)?f:-1},getGcs:function(){return h},update:function(a){this.exists(a.src,a.lookup.Symbol)?g[a.src][a.lookup.Symbol]=a:this.add(a),this.saveToLs()},getChartAndUpdate:function(a,b){var c=this;return this.getChart(a.src,a.lookup.Symbol,b).then(function(b){"mod"===a.src&&(b={test:b}),f.debug("ps",b);for(var d in b){for(var e in b[d])a[e]=b[d][e];c.update(a)}})},clear:function(){g={}}}}]),angular.module("theVarApp").service("ActivateNavBar",function(){return{portfolios:function(){$(".nav.navbar-nav > li").removeClass("active"),$(".nav.navbar-nav > li:nth-child(2)").addClass("active")},assets:function(){$(".nav.navbar-nav > li").removeClass("active"),$(".nav.navbar-nav > li:nth-child(3)").addClass("active")}}}),angular.module("theVarApp").controller("AssetlistCtrl",["$scope","Assets","Portfolios","ActivateNavBar","AssetsRefresher",function(a,b,c,d,e){d.assets(),a.na=function(){return b.na()},a.list=function(){return b.listFlat()},a.del=function(a){b.del(a)},a.nport=function(a,d){return b.exists(a,d)?c.holdingAsset(a,d).length:0},a.assetsRefresher=e}]),angular.module("theVarApp").service("ffa",["$http","$base64","Portfolios","Assets","$q","$timeout","moment","$log",function(a,b,c,d,e,f,g,h){function i(a,b){switch(a){case"config":return console.error("TBD"),!1;case"portfolio":var c={type:"object",properties:{portfolio:{type:"array",items:[{type:"number"},{type:"string",default:"foo"}]},value:{type:"number"},required:["portfolio","value"]}};return b=1,c=1,!0;case"price":return console.error("TBD"),!1;default:return console.error("invalid schema type",a),!1}}function j(a,b,c){var d=a.slice(b*c,b*c+c);return d}var k,l,m={},n=null,o={i:0,n:Number.POSITIVE_INFINITY,r:0,l:0},p=!1,q=0,r="/the-var-config.json?ts="+g().format("x"),s=1;return{np:function(){return Object.keys(m).length},getAvailable:function(){return q},checkAvailable:function(){return q=1,a.get(r).then(function(){q=2},function(){q=0})},ffaConfig1:function(){if(n){var b=e.defer();return f(function(){b.resolve(n)},100),b.promise}return this.checkAvailable().then(function(){return!!q&&a.get(r).then(function(a){return n=a.data},function(a){console.error("error getting config from "+r,a)})})},getStatus:function(){return o},portfolios:function(){return o.r=1,l=this,n?n.hasOwnProperty("accounts")?0===n.accounts.length?void(o.r=0):(m={},this.pstart(0)):this.failConfig("Config missing accounts field"):this.ffaConfig1().then(function(){return l.portfolios()})},setAbort:function(){p=!0,h.error("Will abort")},failConfig:function(a){return o.r=2,e(function(b,c){c(a)})},pstart:function(b){if(l=this,p)return o.r=2,void(p=!1);var e=n.accounts[b];if(h.debug("pst",b,n.accounts,e),!n.hasOwnProperty("endPoints"))return this.failConfig("Config missing endPoints field");if(!e)return this.failConfig("Config account field is empty");if(!e.hasOwnProperty("base"))return this.failConfig("Config missing base field");var f=n.endPoints.portfolios+"?base="+e.base+"&account="+e.a+"&forTheVar=true";return a.get(f).then(function(a){if(h.debug("fc13",a),!i("portfolio",a.data))return this.failConfig("response data for portfolio is invalid");if(!a.data.portfolio)return console.error("response data missing portfolio field",a.data),l.pstart2(b);if(a.data.portfolio.constructor!==Array)return console.error("response data portfolio field is not an array",a.data),l.pstart2(b);var f=e.base+"-"+e.a;m[f]={acc:e,port:a.data.portfolio,cash:a.data.cash};var g=/[a-zA-Z0-9]+ [a-zA-Z]{2} (Equity|Corp)/i;m[f].port.map(function(a){return a.symbolMain=a.TIT_ISIN_BBG,g.test(a.TIT_REU_COD)?a.symbolMain=a.TIT_REU_COD:""===a.TIT_ISIN_BBG&&(a.symbolMain=a.TIT_COD),a.symbAlt=[a.TIT_ISIN_BBG,a.TIT_REU_COD,a.TIT_COD],a.symbAlt=a.symbAlt.filter(function(b){return b!==a.symbolMain&&!!b}),a.symbolMain||console.error("Failed to identify symbol for",a),a});var j=m[f].port.map(function(a){return a.qty||h.error("Missing qty field"),{src:"FFA MF",symbol:a.symbolMain,qty:a.qty?a.qty:0}}),k=c.add("FFA MF",f,j);return c.updateCash(k,m[f].cash),m[f].port.map(function(a){var b={src:"FFA MF",lookup:{Exchange:"-",Symbol:a.symbolMain,SymbAlt:a.symbAlt,Name:a.TIT_NOM}};d.add(b)}),l.pstart2(b)},function(a){console.error("error in getting portfolio of account",a),o.r=2})},pstart2:function(a){return l.np()<n.accounts.length?l.pstart(a+1):void(o.r=0)},readyForPrices:function(){var a=this;if(!n)return!1;if(!n.accounts)return!1;var b=n.accounts.length;return 0!==b&&a.np()===b},portfolioPrices:function(){return this.readyForPrices()?(o.r=1,o.i=0,o.n=Object.keys(m).map(function(a){return m[a].port.length}).reduce(function(a,b){return b?a+b:a},0),this.mwpSingle(0,this)):void console.error("Not yet ready for prices")},mwpPost:function(a){a||(a=1),o.i===o.n?o.r=0:o.i+=a},mwpSingle:function(a,b){if(h.debug("mwpsingle",m,a,p),p)return void(o.r=2);var c=Object.keys(m)[a];return o.i+=m[c].port.filter(function(a){return!a.symbolMain}).length,b.mwpSingle2(a,b).then(function(){b.mwpPost()})},mwpSingle2:function(a,b){h.debug("fdasfdsafdas",m,a,Object.keys(m)[a]);var c=Object.keys(m)[a];if(k=m[c].port.filter(function(a){return a.symbolMain}),0!==k.length)return h.debug("fsdafdsa234234",c,k),b.getChart(0,b,a)},getChart:function(a,b,c){var e=k.map(function(a){return a.symbolMain});if(a>Math.floor(e.length/s))return void console.error("Should not have gotten here",a,e.length,s,Math.floor(e.length/s));var f=j(e,a,s);return d.getChart("FFA MF",f,n).then(function(g){h.debug("res",g,m,f,b),o.i+=f.length-Object.keys(g).length;var i,l=function(a){return a.symbolMain===i};for(i in g){var n=g[i],p=k.filter(l);if(0===p.length)return void console.error("Did not find the code "+i+" ... what?");if(p.length>1)return void console.error("Found more than one code "+i+" ... what?");var q=p[0];h.debug("Doing",q.symbolMain);var r={src:"FFA MF",lookup:{Exchange:"-",Symbol:q.symbolMain,SymbAlt:q.symbAlt,Name:q.TIT_NOM}};for(var t in n)r[t]=n[t];o.l=r.history.length,d.exists(r.src,r.lookup.Symbol)?d.update(r):console.error("How was this asset not yet added?",r),b.mwpPost()}return 0===j(e,a+1,s).length?b.mwpS2Post(c,b):b.getChart(a+1,b,c)},function(a){return console.error("Error",a),b.mwpPost(f.length),b.mwpS2Post(c,b)})},mwpS2Post:function(a,b){return h.debug("fffffff",m),h.debug("moving to next",a,m),a+1<Object.keys(m).length?b.mwpSingle(a+1,b):(h.debug("finished looping"),void b.mwpPost())}}}]),angular.module("theVarApp").service("Settings",["moment",function(a){function b(){return a().format("YYYY-MM-DD")}function c(){return a().subtract(1,"day").format("YYYY-MM-DD")}var d={init:function(){this.end={type:"Today",date:b()},this.length={n:3,u:"year"};var a=localStorage.getItem("settings");a&&(a=angular.fromJson(a),this.setEnd(a.end.type,a.end.date),this.setLength(a.length.n,a.length.u))},start:function(){return a(this.end.date,"YYYY-MM-DD").subtract(this.length.n,this.length.u).format("YYYY-MM-DD")},setEnd:function(a,d){"Today"===a&&(d=b()),"Yesterday"===a&&(d=c()),this.end={type:a,date:d}},setLength:function(a,b){this.length.n=a,this.length.u=b},dashless:function(){var b=a(this.start(),"YYYY-MM-DD").format("YYYYMMDD"),c=a(this.end.date,"YYYY-MM-DD").format("YYYYMMDD");return{start:b,end:c}}};return d.init(),d}]),angular.module("theVarApp").controller("SettingsCtrl",["$scope","Settings","$window",function(a,b,c){a.get=function(){return b},a.saveToLs=function(){localStorage.setItem("settings",angular.toJson(b))},a.setEnd=function(){var c=b.end.type,d=b.end.date;b.setEnd(c,d),a.saveToLs()},a.reset=function(){window.confirm("Are you sure you want to clear all your local data?")&&(localStorage.clear(),c.location.reload())}}]),angular.module("theVarApp").directive("divvar",function(){function a(a,b,c){if(c){var d=a;a=b,b=d}return a>b?"inherit":a<b?"red":"orange"}function b(a,b,c){if(c){var d=a;a=b,b=d}return"Red if "+a.toFixed(2)+" % < "+b.toFixed(2)+" %"}return{restrict:"E",transclude:!0,link:function(c,d,e){e.varisk=parseFloat(e.varisk),e.limit=parseFloat(e.limit),e.usd=parseFloat(e.usd),e.flip=e.hasOwnProperty("flip")&&(""===e.flip||"true"===e.flip);var f=$("<div/>",{style:"color:"+a(100*e.varisk,100*e.limit,e.flip),title:b(100*e.varisk,100*e.limit,e.flip)});$("<div/>").text((100*e.varisk).toFixed(2)+" %").appendTo(f),$("<div/>").text((e.varisk*e.usd).toFixed(2)+" USD").appendTo(f),f.appendTo(d)}}}),angular.module("theVarApp").directive("varmatrix",["$compile","Portfolios",function(a,b){function c(a){return 1===a?"1-day":5===a?"1-week":250===a?"1-year":a+"-day"}function d(a,b,c,d){return $("<divvar/>",{varisk:a,limit:b,usd:c,flip:d})}function e(a){var b=$("<table/>",{class:"table varmatrix",style:"width:40%"});$("<caption/>",{text:"Portfolio VaR (with "+a.unallocated().toFixed(2)+" % unallocated)"}).appendTo(b);var e=$("<tr/>");return $("<th/>",{text:""}).appendTo(e),k.map(function(a){var b=c(a);$("<th/>",{nowrap:"",text:b}).appendTo(e)}),e.appendTo(b),j.map(function(c){e=$("<tr/>"),$("<th/>",{nowrap:"",text:"VaR "+c+" %"}).appendTo(e),k.map(function(b){var f=$("<td/>",{nowrap:""});d(a.portfolioVaR(c,b)*(100-a.unallocated())/100,-.2,a.portfolio.value,!1).appendTo(f),f.appendTo(e)}),e.appendTo(b)}),b}function f(){var a=$("<tr/>");return j.map(function(b){k.map(function(d){$("<th/>",{text:"VaR "+b+"%, "+c(d),class:"varmatrix"}).appendTo(a)})}),a}function g(a){var c=$("<tr/>");return j.map(function(e){k.map(function(f){var g=$("<td/>",{nowrap:"",class:"varmatrix"}),h=a.portfolioVaR(e,a.p,f),i=b.unallocated(a.p.id);d(h*(100-i)/100,-.2,h*a.p.value,!1).appendTo(g),g.appendTo(c)})}),c}function h(a){var b=$("<tr/>");return j.map(function(c){k.map(function(e){var f=a.calculateVaR(a.a,c,e),g=$("<td/>",{nowrap:"",class:"varmatrix"});return a.a.hasOwnProperty("historyMeta")&&a.a.historyMeta.hasOwnProperty("pnl")&&a.a.historyMeta.pnl.hasOwnProperty("last")?(d(f,a.a.historyMeta.pnl.last/100,a.a.pct/100*a.portfolio.value,!0).appendTo(g),void g.appendTo(b)):($("<span/>",{text:"N/A"}).appendTo(g),void g.appendTo(b))})}),b}function i(a){var b=$("<table/>",{class:"table varmatrix"}),d=$("<tr/>");return $("<td/>").appendTo(d),k.map(function(a){var b=c(a);$("<td/>",{text:b}).appendTo(d)}),d.appendTo(b),j.map(function(c){var d=$("<tr/>");$("<td/>",{text:"VaR "+c+"%"}).appendTo(d),k.map(function(b){var e=100*a.calculateVaR(a.pendingStock,c,b);e=e.toFixed(2),$("<td/>",{text:e+" %"}).appendTo(d)}),d.appendTo(b)}),b}var j=[95,99],k=[1,5,250];return{restrict:"EA",transclude:!1,link:function(b,c,d){b.$watch("[unallocated(),a.pct,pendingStock.historyMeta.lastprice,pendingStock.historyMeta.maxdate,pendingStock.historyMeta.mindate,portfolio.value,p.value]",function(){$(c).find('[class*="varmatrix"]').remove();var j;switch(d.type){case"matrix":e(b).appendTo(c),a(c.contents())(b);break;case"rowHeader":j=f(),j.find("th").appendTo(c);break;case"rowBodyPortfolio":j=g(b),j.find("td").appendTo(c),a(c.contents())(b);break;case"rowBodyAsset":j=h(b),j.find("td").appendTo(c),a(c.contents())(b);break;case"column":j=i(b),j.appendTo(c)}})}}}]),angular.module("theVarApp").service("AssetsRefresher",["Assets","ffa","$log",function(a,b,c){function d(){if(0!==k.length){var b=k.pop();return h[i][b].retrieving=!0,a.getChartAndUpdate(h[i][b],g).then(function(){return h[i][b].retrieving=!1,a.saveToLs(),d()})}}function e(){if(0!==j.length)return i=j.pop(),k=Object.keys(h[i]),d().then(function(){return e()})}function f(){return h=a.list(),c.debug("srca",j.length),j=Object.keys(h),e()}var g,h,i,j=[],k=[];return{isRunning:function(){return j.length>0||k.length>0||a.listFlat().filter(function(a){return!!a.retrieving}).length>0},run:function(){g=!1;var a=b.ffaConfig1();return a?a.then(function(a){return g=a,f()}):(console.error("Failed to get ffa config"),f())}}}]),angular.module("theVarApp").run(["$templateCache",function(a){a.put("views/assetAdd.html",'<form class="well form-inline"> <h4> Try typing "Micro" or "GE": <small class="pull-right">Data from <a href="http://dev.markitondemand.com/MODApis/" target="_blank">markit on demand Data Apis v2</a></small> </h4> <input type="text" ng-model="asyncSelected" placeholder="Enter company name or symbol" uib-typeahead="symbol as symbol.Name+\' (\'+symbol.Exchange+\')\' for symbol in getSymbol($viewValue)" typeahead-loading="loadingSymbols" typeahead-no-results="noResults" class="form-control" ng-model-options="modelOptions" size="50"> <i ng-show="loadingSymbols" class="glyphicon glyphicon-refresh"></i> <div ng-show="noResults"> <i class="glyphicon glyphicon-remove"></i> No Results Found </div> <div ng-show="!noResults && !loadingSymbols && asyncSelected.Exchange"> <pre>Model: {{asyncSelected | json}}</pre> <div ng-show="pa!=2"> <button class="btn btn-info" ng-click="getChart()" ng-disabled="exists()||!asyncSelected.Symbol||gcs"> Check prices </button> <span ng-show="gcs==1">Checking prices...</span> <span ng-show="pa==1">No prices available...</span> </div> <div ng-show="pa==2"> <button class="btn btn-primary" ng-click="add1()" ng-disabled="exists()||!asyncSelected.Symbol||gcs||pa!=2"> Show details </button> </div> </div> </form> '),a.put("views/assetlist.html",' <div ng-show="!na()" role="alert"> No assets </div> <table class="table" ng-show="na()"> <caption>Assets &nbsp; <span class="badge">{{np()}}</span></caption> <tr> <td colspan="4"> <a class="btn btn-primary" href="#/assetAdd"> <span class="glyphicon glyphicon-plus"></span> </a> </td> <td> <button class="btn btn-info" ng-click="assetsRefresher.run()" ng-disabled="assetsRefresher.isRunning()" title="Refresh all prices"> <span class="glyphicon glyphicon-refresh"></span> </button> </td> </tr> <tr ng-repeat="a in list()" class="{{!!a.retrieving?\'alert alert-warning\':\'\'}}"> <td>{{a.src}} </td><td>{{a.lookup.Symbol}}</td> <td>{{a.lookup.Name}}</td> <td><span class="badge">{{nport(a.src,a.lookup.Symbol)}}</span></td> <td>{{a.historyMeta.mindate}} .. {{a.historyMeta.maxdate}}</td> <td> <a class="btn btn-xs btn-default" ng-href="#/assetShow/{{a.src}}/{{a.lookup.Symbol}}"> <span class="glyphicon glyphicon-pencil"></span> </a> <button class="btn btn-xs btn-danger" ng-click="del(a.src,a.lookup.Symbol)"> <span class="glyphicon glyphicon-remove"></span> </button> </td> </tr> </table> '),a.put("views/assetshow.html",'<div ng-show="!pendingStock"> None selected </div> <table class="table" ng-show="!!pendingStock"> <tbody> <tr><td width="10em">Source</td><td>{{pendingStock.src}}</td></tr> <tr><td>Symbol</td><td>{{pendingStock.lookup.Symbol}}</td></tr> <tr><td>Alternatives</td><td>{{pendingStock.lookup.SymbAlt.join(",")}}</td></tr> <tr><td>Name</td><td>{{pendingStock.lookup.Name}}</td></tr> <tr><td>Exchange</td><td>{{pendingStock.lookup.Exchange}}</td></tr> <tbody ng-if="!pendingStock.history"> <tr> <td>History</td> <td> <span class="text-warning text-center">No close prices available</span> &nbsp; <button class="btn btn-xs" ng-click="getChart()" ng-disabled="gcs()==1"> <span class="glyphicon glyphicon-refresh"></span> </button> &nbsp; <span ng-show="gcs()==1">Loading prices...</span> <span ng-show="gcs()==2">Error in prices</span> </td> </tr> </tbody> <tbody ng-if="!!pendingStock.history"> <tr> <td>History</td> <td> <div>{{pendingStock.history.length}} points</div> <table class="table"> <tr> <td>First</td> <td>{{pendingStock.historyMeta.mindate}}</td> <td>{{pendingStock.historyMeta.firstprice}} USD</td> <td title="P&L till {{pendingStock.historyMeta.maxdate}}">{{pendingStock.historyMeta.pnl.first|number:2}} %</td> </tr> <tr> <td>Prev EOY</td> <td>{{pendingStock.historyMeta.prevEoyDate}}</td> <td>{{pendingStock.historyMeta.prevEoyClose}} USD</td> <td>{{pendingStock.historyMeta.pnl.eoy|number:2}} %</td> </tr> <tr> <td>Prev EOM</td> <td>{{pendingStock.historyMeta.prevEomDate}}</td> <td>{{pendingStock.historyMeta.prevEomClose}} USD</td> <td>{{pendingStock.historyMeta.pnl.eom|number:2}} %</td> </tr> <tr> <td>Last-1</td> <td>{{pendingStock.historyMeta.tm1date}}</td> <td>{{pendingStock.historyMeta.tm1price}} USD</td> <td>{{pendingStock.historyMeta.pnl.last|number:2}} %</td> </tr> <tr> <td>Last</td> <td>{{pendingStock.historyMeta.maxdate}}</td> <td>{{pendingStock.historyMeta.lastprice}} USD</td> </tr> </table> <div> <button class="btn btn-xs" ng-click="getChart()" ng-disabled="gcs()==1"> <span class="glyphicon glyphicon-refresh"></span> </button> &nbsp; <span ng-show="gcs()==1">Loading prices...</span> <span ng-show="gcs()==2">Error in prices</span> </div> </td> </tr> <tr> <td> Prices plot <br> <button ng-click="showJqplot1=!showJqplot1"> <span ng-show="!showJqplot1">Detailed</span> <span ng-show=" showJqplot1">Summary</span> </button> </td> <td> <div ng-if="!showJqplot1" jq-sparkline ng-model="pendingStock.historyDownsampled" type="line"></div> <!-- http://angular-ui.github.io/ui-chart/ --> <div ng-if=" showJqplot1" ui-chart="[pendingStock.historyJqplot]" chart-options="myChartOpts.usd"></div> </td> </tr> <tr> <td> P&amp;L plot <br> <button ng-click="showJqplot2=!showJqplot2"> <span ng-show="!showJqplot2">Detailed</span> <span ng-show=" showJqplot2">Summary</span> </button> </td> <td> <div ng-if="!showJqplot2" jq-sparkline ng-model="pendingStock.pnlsDownsampled" type="line"></div> <!-- http://angular-ui.github.io/ui-chart/ --> <div ng-if=" showJqplot2" ui-chart="[pendingStock.pnlsJqplot]" chart-options="myChartOpts.perc"></div> </td> </tr> <tr> <td>Empirical distribution</td> <td> <div jq-sparkline ng-model="pendingStock.pnlsEdf" type="bar"></div> </td> </tr> <tr> <td></td> <td> <div> <a href="http://www.reuters.com/finance/stocks/chart?symbol={{pendingStock.lookup.Symbol}}" target="_blank">Source</a> </div> <div> <button class="btn btn-xs btn-info" ng-click="showChart(pendingStock)"> ... </button> </div> </td> </tr> <tr> <td>&nbsp;</td> <td varmatrix type="column"> </tr> </tbody> <tbody> <tr> <td>In portfolios:</td> <td> <span ng-repeat="ip in inPortfolios(false)"> <a ng-href="#/portfolioShow/{{ip.id}}">{{ip.name}}</a> &nbsp;&nbsp; </span> <span ng-show="!inPortfolios(false).length">None</span> </td> </tr> <tr ng-show="inPortfolios(true).length"> <td>Add to portfolio:</td> <td> <span ng-repeat="ip in inPortfolios(true)"> <button ng-click="add2(ip.id)" class="btn btn-primary"> {{ip.name}} </button> &nbsp; </span> </td> </tr> </tbody> <tr> <td></td> <td> <a ng-click="goback()" class="btn btn-danger" ng-show="getPid()"> Cancel </a> </td> </tr> </tbody> </table> <div ng-show="!inPortfolios(true).length || noPortfolios()" class="alert alert-warning text-center"> <span ng-show="!inPortfolios(true).length"> Add more portfolios </span> <span ng-show="noPortfolios()" class="alert alert-warning"> No portfolios to add to. Add a portfolio first. </span> &nbsp; <a class="btn btn-primary" href="#/portfolioAdd"> <span class="glyphicon glyphicon-plus"></span> </a> </div> '),
a.put("views/main.html",'<div class="jumbotron"> <h1>The VaR</h1> <p class="lead"> <img src="images/VaR_diagram_300px.71f0177b.png" alt="VaR diagram"><br> Calculate a portfolio\'s <a href="https://en.wikipedia.org/wiki/Value_at_risk">Value at Risk</a> in your browser </p> <p> <a class="btn btn-lg btn-success" ng-href="#/portfolioList"> List portfolios! <span class="glyphicon glyphicon-ok"></span> <span class="badge">{{np()}}</span> </a> </p> </div> <div class="row marketing"> <h4>Unlimited assets</h4> <p> Add as many assets to your portfolio as your computer can run. </p> <h4>Unlimited portfolios</h4> <p> Add as many portfolios for which to calculate as your keyboard can type. </p> </div> '),a.put("views/portfolioadd.html",'Portfolio name: <input type="text" ng-model="newP.name"> <button class="btn btn-primary" ng-click="add()" ng-disabled="exists()">Add</button> <div class="alert" ng-show="exists()">Name already exists</div> '),a.put("views/portfoliolist.html",'<div class="text-center"> <a class="btn btn-primary" href="#/portfolioAdd"> New portfolio </a> </div> <div ng-show="!np()" role="alert"> No portfolios </div> <table class="table"><!-- ng-show="np()">--> <caption>Portfolios &nbsp; <span class="badge">{{np()}}</span></caption> <thead> <tr varmatrix type="rowHeader"> <th>Source</th> <th>Name</th> <th>Value</th> <th>Cash</th> <th>Securities</th> </tr> </thead> <tbody ng-repeat="p in list()"> <tr varmatrix type="rowBodyPortfolio"> <td>{{p.src}}</td> <td> <a ng-href="#/portfolioShow/{{p.id}}"> {{p.name}} </a> </td> <td>{{p.value|number:2}} USD</td> <td>{{p.cash|number:2}} USD</td> <td> <span class="badge">{{nass(p.id)}}</span> </td> </tr> </tbody> </table> <hr> <div ng-show="ffaGA()!=2" class="alert alert-warning text-center"> FFA portfolios not available <button class="btn btn-info btn-xs" ng-click="ffaCA()" ng-disabled="ffaGA()==1" title="Retry"> <span ng-show="ffaGA()==0" class="glyphicon glyphicon-repeat"></span> <span ng-show="ffaGA()==1">Checking...</span> </button> </div> <div ng-show="ffaGA()==2"> <button class="btn btn-info" ng-click="ffaPortfolios()" ng-disabled="ffaPStatus().r==1"> Retrieve FFA portfolios </button> <button class="btn btn-info" ng-click="ffaPrices()" ng-disabled="!ffaReadyForPrices()||ffaPStatus().r==1"> Retrieve FFA prices </button> <div ng-show="ffaPStatus().r==1"> <button class="btn" ng-click="ffaAbort()"> Abort </button> &nbsp; Loading FFA prices: {{ffaPStatus().i}} / {{ffaPStatus().n}} &nbsp; Last n points: {{ffaPStatus().l}} </div> <div ng-show="ffaPStatus().r==2">Error in FFA portfolios</div> <div ng-show="ffaN()"> FFA portfolios &nbsp; <table class="table"> <tr ng-repeat="p in ffaPortfolios"> <td>{{p.acc.base}}</td> <td>{{p.acc.a}}</td> <td>{{p.port.length}} securities</td> </tr> </table> </div> </div><!-- end ffaGA()==2 --> '),a.put("views/portfolioshow.html",' <span> <table class="table table-condensed" border="0"> <tr class="h2"> <td class="pull-right">Portfolio</td> <td><input type="text" ng-model="portfolio.name" ng-change="updateName()"></td> <td> <span class="pull-right"> <a class="btn btn-xs btn-primary" href="#/assetAdd?pid={{portfolio.id}}"> Add asset </a> <button class="btn btn-xs btn-danger" ng-click="delPortfolio()"> Delete portfolio </button> </span> </td> </tr> <tr> <td class="pull-right">Cash (USD)</td> <td> <input type="number" ng-model="portfolio.cash" ng-change="updateCash()"> &nbsp; {{unallocated()|number:2}} % </td> </tr> <tr> <td class="pull-right">Value (USD)</td> <td>{{portfolio.value|number:2}}</td> </tr> </table> </span> <div ng-show="!alist.length" class="alert alert-warning"> No assets </div> <div ng-show="alist.length"> <div> <varmatrix type="matrix"></varmatrix> </div> <br> <label> <input type="checkbox" ng-model="showNoData"> Show assets with no data </label> <br> <table class="table"> <tr varmatrix type="rowHeader"> <th>&nbsp;</th> <th>&nbsp;</th> <th>Symbol</th> <th>Alternatives</th> <th>Name</th> <th>Exchange</th> <th> Price <br>Max date <br>P&amp;L </th> <th>Qty</th> <th>Weight</th> <th>History</th> <th>&nbsp;</th> </tr> <tbody ng-repeat="a in alist track by $index"> <tr varmatrix type="rowBodyAsset" ng-show="!!a.history||showNoData"> <!--a.src+a.lookup.Symbol">--> <td>{{$index+1}}</td> <td nowrap> <a class="btn btn-xs btn-info" ng-href="#/assetShow/{{a.src}}/{{a.lookup.Symbol}}?pid={{portfolio.id}}" title="Show details" ng-disabled="!a.src || !a.lookup.Symbol"> <span class="glyphicon glyphicon-search"></span> </a> &nbsp; <button class="btn btn-danger btn-xs" ng-click="delAsset(a)" title="Delete asset from portfolio"> <span class="glyphicon glyphicon-remove"></span> </button> </td> <td>{{a.lookup.Symbol}}</td> <td>{{a.lookup.SymbAlt.join(",")}}</td> <td>{{a.lookup.Name}}</td> <td>{{a.lookup.Exchange}}</td> <td> {{a.historyMeta.lastprice|number:2}} USD <br>{{a.historyMeta.maxdate}} <br>{{a.historyMeta.pnl.last|number:2}} % </td> <td nowrap> <input type="number" min="0" step="any" ng-value="a.qty?a.qty:0" style="width:5em" ng-model="a.qty" ng-change="updateAsset(a)"> share(s) <div>{{a.qty*a.historyMeta.lastprice|number:2}} USD</div> </td> <td nowrap> <!-- using a.pct here doesnt get updated in real-time --> {{qty2pct(a,portfolio)|number:2}} % </td> <td> {{a.history?a.history.length:0}} points <br> {{a.historyMeta.mindate}} .. {{a.historyMeta.maxdate}} </td> <td> <div jq-sparkline ng-model="a.pnlsEdf" type="bar" ng-if="a.pnlsEdf"></div> </td> </tr> </tbody> </table> </div> '),a.put("views/settings.html",'<p>This is the Settings view.</p> <ul> <li> End date: <select ng-model="get().end.type" ng-change="setEnd()" ng-options="x for x in [\'Today\',\'Yesterday\',\'Custom date\']"></select> <input type="text" ng-model="get().end.date" ng-change="saveToLs()" ng-disabled="get().end.type==\'Today\'||get().end.type==\'Yesterday\'"> </li> <li> Length: <select ng-options="x as x for x in [1,2,3,4,5,6,7,8,9,10,11]" ng-model="get().length.n" ng-change="saveToLs()"></select> <select ng-options="x as x for x in [\'year\',\'month\']" ng-model="get().length.u" ng-change="saveToLs()"></select> </li> <li>Start date: {{get().start()}}</li> <li><button class="btn btn-danger" ng-click="reset()">Clear all data</button></li> </ul> ')}]);