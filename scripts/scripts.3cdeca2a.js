"use strict";angular.module("theVarApp",["ngMessages","ngRoute","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).when("/assetAdd",{templateUrl:"views/assetAdd.html",controller:"AssetAddCtrl",controllerAs:"assetAdd"}).when("/portfolioList",{templateUrl:"views/portfoliolist.html",controller:"PortfoliolistCtrl",controllerAs:"portfolioList"}).when("/portfolioAdd",{templateUrl:"views/portfolioadd.html",controller:"PortfolioaddCtrl",controllerAs:"portfolioAdd"}).when("/portfolioShow/:pid",{templateUrl:"views/portfolioshow.html",controller:"PortfolioshowCtrl",controllerAs:"portfolioShow"}).when("/assetShow/:src/:symbol",{templateUrl:"views/assetshow.html",controller:"AssetshowCtrl",controllerAs:"assetShow"}).when("/assetList",{templateUrl:"views/assetlist.html",controller:"AssetlistCtrl",controllerAs:"assetList"}).otherwise({redirectTo:"/"})}]),angular.module("theVarApp").controller("MainCtrl",["$scope","Portfolios",function(a,b){a.np=function(){return b.np()}}]),angular.module("theVarApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("theVarApp").controller("AssetAddCtrl",["$scope","varCalc","markitOnDemand","Portfolios","$routeParams",function(a,b,c,d,e){a.pendingStock=!1,a.add1=function(){var b="mod",c=a.asyncSelected.Symbol;a.asyncSelected=null;var d="#/assetShow/"+b+"/"+c;e.pid&&(d+="?pid="+e.pid),window.location.href=d},a.getSymbol=function(b){return a.pa=0,a.asyncSelected=null,c.lookup(b)},a.modelOptions={debounce:{"default":500,blur:250},getterSetter:!0},a.getQuote=function(a){return c.quote(a)},a.gcs=0,a.pa=0,a.getChart=function(){if(a.asyncSelected){var b=a.asyncSelected.Symbol;return a.gcs=1,c.interactiveChart(b).then(function(b){return a.gcs=0,0===b.data.Elements.length?void(a.pa=1):void(a.pa=2)})}}}]),angular.module("theVarApp").directive("jqSparkline",["$timeout",function(a){return{restrict:"A",require:"ngModel",link:function(b,c,d,e){var f={};f.type=d.type||"line",b.$watch(d.ngModel,function(){a(function(){g()},100)}),b.$watch(d.opts,function(){a(function(){g()},100)});var g=function(){var a;d.opts&&angular.extend(f,angular.fromJson(d.opts)),a=angular.isString(e.$viewValue)?e.$viewValue.replace(/(^,)|(,$)/g,""):e.$viewValue;var b;b=angular.isArray(a)?a:a.split(","),$(c).sparkline(b,f)}}}}]),angular.module("theVarApp").controller("PortfoliolistCtrl",["$scope","Portfolios","ActivateNavBar","Assets","varCalc",function(a,b,c,d,e){c.portfolios(),a.np=function(){return b.np()},a.list=function(){return b.list()},a.nass=function(a){var c=b.list();return c.hasOwnProperty(a)?(c=c[a],c.hasOwnProperty("assets")?(c=c.assets,Object.keys(c).length):0):0},a.portfolioVaR=function(a,b){var c=b.assets;if(!c)return 0;var f=d.list(),g=c.map(function(a){return f.hasOwnProperty(a.src)&&f[a.src].hasOwnProperty(a.symbol)?f[a.src][a.symbol]:null}).filter(function(a){return!!a});return e.portfolioVaR(a,g)}}]),angular.module("theVarApp").controller("PortfolioaddCtrl",["$scope","Portfolios","$location","ActivateNavBar",function(a,b,c,d){d.portfolios(),a.add=function(){a.portfolios||(a.portfolios={}),a.newP.id=a.newId(),b.add(a.newP)&&(window.location.href="#/portfolioShow/"+a.newP.id)},a.newId=function(){var a=1;if(0!==b.np()){var c=b.list();a=Object.keys(c).map(function(a){return c[a].id}),a=a.reduce(function(a,b){return b>a?b:a}),a=1+a}return a},a.exists=function(){if(!a.newP)return!1;var c=b.list();return Object.keys(c).filter(function(b){return c[b].name===a.newP.name}).length>0}}]),angular.module("theVarApp").service("Portfolios",function(){var a={};return localStorage.getItem("ppp")&&(a=angular.fromJson(localStorage.getItem("ppp"))),{list:function(){return a},np:function(){return Object.keys(a).length},add:function(b){return b.id&&b.name?a.hasOwnProperty(b.id)?(console.error("ID "+b.id+" already exists"),!1):(a[b.id]=angular.fromJson(angular.toJson(b)),this.saveToLs(),this):(console.error("Adding invalid portfolio "+angular.toJson(b)),!1)},del:function(b){delete a[b],this.saveToLs()},saveToLs:function(){localStorage.setItem("ppp",angular.toJson(a))},addAsset:function(b,c){return a.hasOwnProperty(b)?(a[b].assets||(a[b].assets=[]),void(0===a[b].assets.filter(function(a){return a.src===c.src&&a.symbol===c.lookup.Symbol}).length&&(a[b].assets.push({src:c.src,symbol:c.lookup.Symbol}),this.saveToLs()))):(console.error("Invalid portfolio ID "+b),!1)},rmAsset:function(b,c){if(!a.hasOwnProperty(b))return console.error("Invalid portfolio ID "+b),!1;var d=a[b].assets.filter(function(a){return a.src!==c.src||a.symbol!==c.lookup.Symbol});a[b].assets=d,this.saveToLs()},holdingAsset:function(b,c,d){return Object.keys(a).filter(function(e){if(!a[e].hasOwnProperty("assets"))return d?!0:!1;var f=a[e].assets.filter(function(a){return a.src===b&&a.symbol===c}).length>0;return d?!f:f}).map(function(b){return a[b]})}}}),angular.module("theVarApp").controller("PortfolioshowCtrl",["$scope","Portfolios","$routeParams","varCalc","Assets","ActivateNavBar",function(a,b,c,d,e,f){f.portfolios();var g=c.pid,h=b.list();return h.hasOwnProperty(g)?(a.portfolio=h[g],a.list=function(){var b=a.portfolio.assets;if(!b)return!1;var c=e.list(),d=b.map(function(a){return c.hasOwnProperty(a.src)&&c[a.src].hasOwnProperty(a.symbol)?c[a.src][a.symbol]:null}).filter(function(a){return!!a});return d},a.alist=a.list(),a.calculateVaR=function(a,b){return d.calculateVaR(a,b)},a.edf=function(a,b){return d.edf(a,b)},a.portfolioVaR=function(b){return d.portfolioVaR(b,a.alist)},a.delAsset=function(c){window.confirm("Are you sure you want to delete the asset from the portfolio?")&&(b.rmAsset(g,c),a.portfolio=b.list()[g],a.alist=a.list())},void(a.delPortfolio=function(){window.confirm("Are you sure you want to delete the portfolio?")&&(b.del(g),window.location.href="#/portfolioList")})):(window.location.href="#/portfolioList",void console.error("Invalid portfolio id "+g))}]),angular.module("theVarApp").service("varCalc",function(){return{calculateVaR:function(a,b){if(a.pnlsSort&&0!==a.pnlsSort.length){var c=a.pnlsSort,d=c.length,e=d*((100-b)/100)-1,f=Math.min(d-1,Math.max(0,Math.ceil(e))),g=Math.min(d-1,Math.max(0,Math.floor(e)));return g===f?c[f]:(f-e)*c[g]+(e-g)*c[f]}},edf:function(a,b){var c=angular.fromJson(angular.toJson(a));c.sort(function(a,b){return a-b});var d=c.reduce(function(a,b){return b>a?a:b},9999);d=Math.floor(d/b)*b;for(var e=c.map(function(a){return Math.floor((a-d)/b)}),f=[],g=[],h=0;h<e.length;h++){var i=1;c[h]<0&&(i=-1),-1===g.indexOf(e[h])?(f.push(i),g.push(e[h])):f[f.length-1]+=i}var j=f.map(function(a){return a/c.length*100});return j},portfolioVaR:function(a,b){if(b){var c=Object.keys(b).filter(function(a){return b[a].selected}).map(function(a){return b[a].pnlsSort}).reduce(function(a,b){return b?$.merge(a,b):a},[]);return c.length?(c.sort(function(a,b){return a-b}),this.calculateVaR({pnlsSort:c},a)):0}}}}),angular.module("theVarApp").service("markitOnDemand",["$http",function(a){return{lookup:function(b){var c="http://dev.markitondemand.com/MODApis/Api/v2/Lookup/jsonp";return a.jsonp(c,{params:{input:b,jsoncallback:"JSON_CALLBACK"}}).then(function(a){return a.data})},quote:function(b){var c="http://dev.markitondemand.com/MODApis/Api/v2/Quote/jsonp";return a.jsonp(c,{params:{symbol:b.symbol.Symbol,jsoncallback:"JSON_CALLBACK"}}).then(function(a){return a.data})},interactiveChart:function(b){var c="http://dev.markitondemand.com/MODApis/Api/v2/InteractiveChart/jsonp";return a.jsonp(c,{params:{parameters:{DataPeriod:"Day",NumberOfDays:365,Normalized:!1,Elements:[{Symbol:b,Type:"price",Params:["c"]}]},jsoncallback:"JSON_CALLBACK"}})}}}]),angular.module("theVarApp").controller("AssetshowCtrl",["$routeParams","markitOnDemand","varCalc","Assets","$scope","Portfolios","ActivateNavBar",function(a,b,c,d,e,f,g){g.assets();var h=a.symbol,i=a.src;e.goback=function(){a.pid&&(window.location.href="#/portfolioShow/"+a.pid)},e.pendingStock=!1;var j=d.list();j.hasOwnProperty(i)&&j[i].hasOwnProperty(h)&&(e.pendingStock=j[i][h]),e.add1=function(){b.lookup(h).then(function(a){var b=a.filter(function(a){return a.Symbol===h});return 0===b.length?void console.error("Couldnt identify symbol"):(b=b[0],e.pendingStock={src:i,lookup:b},void e.getChart())})},e.pendingStock||e.add1(),e.getPid=function(){return a.pid},e.add2=function(a){d.add(e.pendingStock),f.addAsset(a,e.pendingStock),e.pendingStock=!1,e.asyncSelected=null,window.location.href="#/portfolioShow/"+a},e.noPortfolios=function(){return 0===f.np()},e.inPortfolios=function(a){return!e.pendingStock||e.noPortfolios()?[]:f.holdingAsset(i,h,a)},e.gcs=0,e.getChart=function(){return e.gcs=1,b.interactiveChart(h).then(function(a){if(e.gcs=0,0!==a.data.Elements.length){for(var b=a.data.Dates,c=a.data.Elements[0].DataSeries.close.values,d=[],f=0;f<b.length;f++)d.push({date:b[f],close:c[f]});e.pendingStock.history=d,e.pendingStock.history2=angular.fromJson(angular.toJson(c)),e.pendingStock.historyMeta={mindate:b[0],maxdate:b[b.length-1]};var g=[];for(g.push(0),f=1;f<c.length;f++)g.push(c[f]/c[f-1]-1);e.pendingStock.pnls=g;var h=angular.fromJson(angular.toJson(g));h.sort(function(a,b){return a-b}),e.pendingStock.pnlsSort=h,e.pendingStock.pnlsEdf=e.edf(g,.01),e.pendingStock.selected=!0}})},e.showChart=function(a){console.log(a)},e.calculateVaR=function(a,b){return c.calculateVaR(a,b)},e.edf=function(a,b){return c.edf(a,b)}}]),angular.module("theVarApp").service("Assets",function(){var a={};return localStorage.getItem("aaa")&&(a=angular.fromJson(localStorage.getItem("aaa"))),{add:function(b){a.hasOwnProperty(b.src)||(a[b.src]={}),a[b.src].hasOwnProperty(b.lookup.Symbol)||(a[b.src][b.lookup.Symbol]=b,this.saveToLs())},list:function(){return a},saveToLs:function(){localStorage.setItem("aaa",angular.toJson(a))},na:function(){return Object.keys(a).length},del:function(b,c){this.exists(b,c)&&(delete a[b][c],0===Object.keys(a[b]).length&&delete a[b],this.saveToLs())},exists:function(b,c){return a.hasOwnProperty(b)&&a[b].hasOwnProperty(c)?!0:!1}}}),angular.module("theVarApp").service("ActivateNavBar",function(){return{portfolios:function(){$(".nav.navbar-nav > li").removeClass("active"),$(".nav.navbar-nav > li:nth-child(2)").addClass("active")},assets:function(){$(".nav.navbar-nav > li").removeClass("active"),$(".nav.navbar-nav > li:nth-child(3)").addClass("active")}}}),angular.module("theVarApp").controller("AssetlistCtrl",["$scope","Assets","Portfolios","ActivateNavBar",function(a,b,c,d){d.assets(),a.na=function(){return b.na()},a.list=function(){var a=b.list(),c=[];return Object.keys(a).map(function(b){Object.keys(a[b]).map(function(d){c.push(a[b][d])})}),c},a.del=function(a){b.del(a)},a.nport=function(a,d){return b.exists(a,d)?c.holdingAsset(a,d).length:0}}]),angular.module("theVarApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/assetAdd.html",'<form class="well form-inline"> <h4> Try typing "Micro" or "GE": <small class="pull-right">Data from <a href="http://dev.markitondemand.com/MODApis/" target="_blank">markit on demand Data Apis v2</a></small> </h4> <input type="text" ng-model="asyncSelected" placeholder="Enter company name or symbol" uib-typeahead="symbol as symbol.Name+\' (\'+symbol.Exchange+\')\' for symbol in getSymbol($viewValue)" typeahead-loading="loadingSymbols" typeahead-no-results="noResults" class="form-control" ng-model-options="modelOptions" size="50"> <i ng-show="loadingSymbols" class="glyphicon glyphicon-refresh"></i> <div ng-show="noResults"> <i class="glyphicon glyphicon-remove"></i> No Results Found </div> <div ng-show="!noResults && !loadingSymbols && asyncSelected.Exchange"> <pre>Model: {{asyncSelected | json}}</pre> <div ng-show="pa!=2"> <button class="btn btn-info" ng-click="getChart()" ng-disabled="exists()||!asyncSelected.Symbol||gcs"> Check prices </button> <span ng-show="gcs==1">Checking prices...</span> <span ng-show="pa==1">No prices available...</span> </div> <div ng-show="pa==2"> <button class="btn btn-primary" ng-click="add1()" ng-disabled="exists()||!asyncSelected.Symbol||gcs||pa!=2"> Show details </button> </div> </div> </form>'),a.put("views/assetlist.html",'<a class="btn btn-primary" href="/#assetAdd"> <span class="glyphicon glyphicon-plus"></span> </a> <div ng-show="!na()" role="alert"> No assets </div> <table class="table" ng-show="na()"> <caption>Assets &nbsp; <span class="badge">{{np()}}</span></caption> <tr ng-repeat="a in list()"> <td>{{a.src}} </td><td>{{a.lookup.Symbol}}</td> <td><span class="badge">{{nport(a.src,a.lookup.Symbol)}}</span></td> <td> <a class="btn btn-xs btn-default" ng-href="#/assetShow/{{a.src}}/{{a.lookup.Symbol}}"> <span class="glyphicon glyphicon-pencil"></span> </a> <button class="btn btn-xs btn-danger" ng-click="del(a.src,a.lookup.Symbol)"> <span class="glyphicon glyphicon-remove"></span> </button> </td> </tr> </table>'),a.put("views/assetshow.html",'<div ng-show="!pendingStock"> None selected </div> <table class="table" ng-show="!!pendingStock"> <tbody> <tr><td width="10em">Source</td><td>{{pendingStock.src}}</td></tr> <tr><td>Symbol</td><td>{{pendingStock.lookup.Symbol}}</td></tr> <tr><td>Name</td><td>{{pendingStock.lookup.Name}}</td></tr> <tr><td>Exchange</td><td>{{pendingStock.lookup.Exchange}}</td></tr> <tbody ng-show="!pendingStock.history"> <tr> <td>History</td> <td> <span class="text-warning text-center">No close prices available</span> &nbsp; <button class="btn btn-xs btn-warning" ng-click="getChart()" ng-disabled="gcs"> <span class="glyphicon glyphicon-refresh"></span> </button> &nbsp; <span ng-show="gcs"> Loading prices... </span> </td> </tr> </tbody> <tbody ng-show="pendingStock.history"> <tr> <td>History</td> <td> <div>{{pendingStock.history.length}} points</div> <div>{{pendingStock.historyMeta.mindate}} .. {{pendingStock.historyMeta.maxdate}}</div> <div> <button class="btn btn-xs" ng-click="getChart()"> <span class="glyphicon glyphicon-refresh"></span> </button> </div> <div jq-sparkline ng-model="pendingStock.history2" type="line" ng-if="pendingStock.history2"></div> </td> </tr> <tr> <td>Empirical distribution</td> <td> <div jq-sparkline ng-model="pendingStock.pnlsEdf" type="bar" ng-if="pendingStock.pnlsEdf"></div> </td> </tr> <tr> <td></td> <td> <div> <a href="http://www.reuters.com/finance/stocks/chart?symbol={{pendingStock.lookup.Symbol}}" target="_blank">Source</a> </div> <div> <button class="btn btn-xs btn-info" ng-click="showChart(pendingStock)"> ... </button> </div> </td> </tr> <tr> <td> VaR (95%) &nbsp; based on <a href="https://gist.github.com/deenar/f97d517d3188fc7b5302" target="_blank">this</a> </td> <td>{{100*calculateVaR(pendingStock,95)|number:2}} %</td> </tr> <tr> <td>In portfolios:</td> <td> <span ng-repeat="ip in inPortfolios(false)"> <a ng-href="#/portfolioShow/{{ip.id}}">{{ip.name}}</a> &nbsp;&nbsp; </span> <span ng-show="!inPortfolios(false).length">None</span> </td> </tr> <tr ng-show="inPortfolios(true).length"> <td>Add to portfolio:</td> <td> <span ng-repeat="ip in inPortfolios(true)"> <button ng-click="add2(ip.id)" class="btn btn-primary"> {{ip.name}} </button> &nbsp; </span> </td> </tr> </tbody> <tr> <td></td> <td> <a ng-click="goback()" class="btn btn-danger" ng-show="getPid()"> Cancel </a> </td> </tr> </tbody> </table> <div ng-show="!inPortfolios(true).length || noPortfolios()" class="alert alert-warning text-center"> <span ng-show="!inPortfolios(true).length"> Add more portfolios </span> <span ng-show="noPortfolios()" class="alert alert-warning"> No portfolios to add to. Add a portfolio first. </span> &nbsp; <a class="btn btn-primary" href="/#portfolioAdd"> <span class="glyphicon glyphicon-plus"></span> </a> </div>'),a.put("views/main.html",'<div class="jumbotron"> <h1>The VaR</h1> <p class="lead"> <img src="images/VaR_diagram_300px.71f0177b.png" alt="VaR diagram"><br> Calculate a portfolio\'s <a href="https://en.wikipedia.org/wiki/Value_at_risk">Value at Risk</a> in your browser </p> <p> <a class="btn btn-lg btn-success" ng-href="#/portfolioList"> List portfolios! <span class="glyphicon glyphicon-ok"></span> <span class="badge">{{np()}}</span> </a> </p> </div> <div class="row marketing"> <h4>Unlimited assets</h4> <p> Add as many assets to your portfolio as your computer can run. </p> <h4>Unlimited portfolios</h4> <p> Add as many portfolios for which to calculate as your keyboard can type. </p> </div>'),a.put("views/portfolioadd.html",'Portfolio name: <input type="text" ng-model="newP.name"> <button class="btn btn-primary" ng-click="add()" ng-disabled="exists()">Add</button> <div class="alert" ng-show="exists()">Name already exists</div>'),a.put("views/portfoliolist.html",'<div class="text-center"> <a class="btn btn-primary" href="/#portfolioAdd"> New portfolio </a> </div> <div ng-show="!np()" role="alert"> No portfolios </div> <table class="table" ng-show="np()"> <caption>Portfolios &nbsp; <span class="badge">{{np()}}</span></caption> <tr> <th>Name</th> <th>Number of securities</th> <th>VaR 95%</th> </tr> <tr ng-repeat="p in list()"> <td> <a ng-href="#/portfolioShow/{{p.id}}"> {{p.name}} </a> </td> <td> <span class="badge">{{nass(p.id)}}</span> </td> <td>{{100*portfolioVaR(95,p)|number:2}} %</td> </tr> </table>'),a.put("views/portfolioshow.html",'<h2> <span>Portfolio: {{portfolio.name}}</span> <span class="pull-right"> <a class="btn btn-xs btn-primary" href="#/assetAdd?pid={{portfolio.id}}"> Add asset </a> <button class="btn btn-xs btn-danger" ng-click="delPortfolio()"> Delete portfolio </button> </span> </h2> <div ng-show="!alist.length" class="alert alert-warning"> No assets </div> <div ng-show="alist.length"> <div>Portfolio VaR 95%: {{100*portfolioVaR(95)|number:2}} %</div> <br> <table class="table"> <tr> <th>&nbsp;</th> <th>Symbol</th> <th>Name</th> <th>Exchange</th> <th>&nbsp;</th> <th> VaR (95%) &nbsp; based on <a href="https://gist.github.com/deenar/f97d517d3188fc7b5302" target="_blank">this</a> </th> <th>&nbsp;</th> </tr> <tr ng-repeat="a in alist track by a.src+a.lookup.Symbol"> <td><input type="checkbox" ng-model="a.selected"></td> <td>{{a.lookup.Symbol}}</td> <td>{{a.lookup.Name}}</td> <td>{{a.lookup.Exchange}}</td> <td> <div jq-sparkline ng-model="a.pnlsEdf" type="bar" ng-if="a.pnlsEdf"></div> </td> <td> {{100*calculateVaR(a,95)|number:2}} % </td> <td nowrap> <a class="btn btn-xs btn-info" ng-href="#/assetShow/{{a.src}}/{{a.lookup.Symbol}}?pid={{portfolio.id}}" title="Show details"> <span class="glyphicon glyphicon-search"></span> </a> &nbsp; <button class="btn btn-danger btn-xs" ng-click="delAsset(a)" title="Delete asset from portfolio"> <span class="glyphicon glyphicon-remove"></span> </button> </td> </tr> </table> </div>')}]);